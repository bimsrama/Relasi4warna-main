# ===========================================
# Relasi4Warna - Deploy to VPS Workflow
# ===========================================
# Manual trigger to deploy to VPS via SSH
# 
# Required Secrets:
# - VPS_HOST: Your VPS IP or domain
# - VPS_USER: SSH username
# - VPS_SSH_KEY: Private SSH key
# - MONGO_URL: MongoDB connection string
# - JWT_SECRET: JWT secret key
# - EMERGENT_LLM_KEY: Emergent LLM API key
# - MIDTRANS_SERVER_KEY: Midtrans server key
# - MIDTRANS_CLIENT_KEY: Midtrans client key
# - REACT_APP_BACKEND_URL: Frontend API URL
# ===========================================

name: Deploy to VPS

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Deployment environment'
        required: true
        default: 'production'
        type: choice
        options:
          - production
          - staging

jobs:
  deploy:
    name: Deploy to VPS
    runs-on: ubuntu-latest
    environment: ${{ github.event.inputs.environment }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup SSH
        uses: webfactory/ssh-agent@v0.8.0
        with:
          ssh-private-key: ${{ secrets.VPS_SSH_KEY }}

      - name: Add VPS to known hosts
        run: |
          mkdir -p ~/.ssh
          ssh-keyscan -H ${{ secrets.VPS_HOST }} >> ~/.ssh/known_hosts

      - name: Create deployment directory
        run: |
          ssh ${{ secrets.VPS_USER }}@${{ secrets.VPS_HOST }} "mkdir -p ~/relasi4warna"

      - name: Copy files to VPS
        run: |
          rsync -avz --delete \
            --exclude='.git' \
            --exclude='node_modules' \
            --exclude='__pycache__' \
            --exclude='.env' \
            --exclude='*.pyc' \
            ./ ${{ secrets.VPS_USER }}@${{ secrets.VPS_HOST }}:~/relasi4warna/

      - name: Create .env file on VPS
        run: |
          ssh ${{ secrets.VPS_USER }}@${{ secrets.VPS_HOST }} << 'ENVSSH'
          cat > ~/relasi4warna/.env << 'EOF'
          MONGO_URL=${{ secrets.MONGO_URL }}
          DB_NAME=relasi4warna
          JWT_SECRET=${{ secrets.JWT_SECRET }}
          EMERGENT_LLM_KEY=${{ secrets.EMERGENT_LLM_KEY }}
          MIDTRANS_SERVER_KEY=${{ secrets.MIDTRANS_SERVER_KEY }}
          MIDTRANS_CLIENT_KEY=${{ secrets.MIDTRANS_CLIENT_KEY }}
          MIDTRANS_IS_PRODUCTION=${{ github.event.inputs.environment == 'production' }}
          REACT_APP_BACKEND_URL=${{ secrets.REACT_APP_BACKEND_URL }}
          EOF
          ENVSSH

      - name: Build and deploy with Docker Compose
        run: |
          ssh ${{ secrets.VPS_USER }}@${{ secrets.VPS_HOST }} << 'DEPLOYSSH'
          cd ~/relasi4warna
          
          # Stop existing containers
          docker compose down || true
          
          # Build new images
          docker compose build --no-cache
          
          # Start services
          docker compose up -d
          
          # Wait for health checks
          sleep 30
          
          # Verify deployment
          curl -f http://localhost:80/health || exit 1
          echo "✓ Deployment successful!"
          
          # Clean up old images
          docker image prune -f
          DEPLOYSSH

      - name: Verify deployment
        run: |
          sleep 10
          curl -f http://${{ secrets.VPS_HOST }}/health && echo "✓ Application is healthy!"
