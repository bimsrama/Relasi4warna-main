name: Fullstack Build & Push



on:

  push:

    branches: [ "main" ]



env:

  REGISTRY: ghcr.io

  IMAGE_NAME: ${{ github.repository }}



jobs:

  # ===========================================

  # Job 1: Backend Verification (Full Install)

  # ===========================================

  test-backend:

    name: Backend Verification

    runs-on: ubuntu-latest

    steps:

      - name: Checkout code

        uses: actions/checkout@v4



      - name: Set up Python

        uses: actions/setup-python@v5

        with:

          python-version: '3.11'

          # CACHE DIMATIKAN (Sapu Bersih)



      - name: Install Dependencies

        run: |

          cd backend

          pip install --upgrade pip

          pip install -r requirements.txt



      - name: Verify Imports

        run: |

          # Paksa Python membaca folder packages di root

          export PYTHONPATH=$PYTHONPATH:$(pwd)/packages

          

          cd backend

          # Cek apakah server bisa start tanpa error import

          python -c "from server import app; print('âœ“ Server imports OK')"

        env:

          # Dummy env vars agar tidak error

          MONGO_URL: mongodb://localhost:27017/test

          DB_NAME: test

          JWT_SECRET: dummy

          EMERGENT_LLM_KEY: dummy

          MIDTRANS_SERVER_KEY: dummy

          MIDTRANS_CLIENT_KEY: dummy



  # ===========================================

  # Job 2: Frontend Verification (Full Install)

  # ===========================================

  test-frontend:

    name: Frontend Verification

    runs-on: ubuntu-latest

    steps:

      - name: Checkout code

        uses: actions/checkout@v4



      - name: Set up Node.js

        uses: actions/setup-node@v4

        with:

          node-version: '18'

          # CACHE DIMATIKAN (Sapu Bersih)



      - name: Install & Build

        run: |

          cd frontend

          # Hapus node_modules lama jika ada (biar yakin bersih)

          rm -rf node_modules

          rm -f package-lock.json

          

          # Install fresh

          npm install --legacy-peer-deps

          npm install ajv@8 --save-dev --legacy-peer-deps

          

          # Coba Build

          npm run build

        env:

          REACT_APP_BACKEND_URL: http://relasi4warna.com

          CI: false



  # ===========================================

  # Job 3: Build & Push Docker (Final)

  # ===========================================

  build-push:

    name: Build & Push Docker

    runs-on: ubuntu-latest

    needs: [test-backend, test-frontend]

    

    steps:

      - name: Checkout Code

        uses: actions/checkout@v4



      - name: Login ke Docker Hub

        uses: docker/login-action@v3

        with:

          username: ${{ secrets.DOCKER_USERNAME }}

          password: ${{ secrets.DOCKER_PASSWORD }}



      # Build Backend

      - name: Build Backend

        uses: docker/build-push-action@v5

        with:

          context: .

          file: infra/docker/Dockerfile.backend

          push: true

          tags: bimsrama/relasi4warna:backend



      # Build Frontend

      - name: Build Frontend

        uses: docker/build-push-action@v5

        with:

          context: .

          file: infra/docker/Dockerfile.frontend

          push: true

          tags: bimsrama/relasi4warna:frontend

          build-args: |

            REACT_APP_BACKEND_URL=http://relasi4warna.com
