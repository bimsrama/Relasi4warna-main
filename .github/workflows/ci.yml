name: Fullstack Build & Push

on:
  push:
    branches: [ "main" ]

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

jobs:
  # ===========================================
  # Job 1: Backend Tests
  # ===========================================
  test-backend:
    name: Backend Verification
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          # Cache dimatikan dulu biar aman
          # cache: 'pip' 

      - name: Install dependencies
        run: |
          cd backend
          pip install --upgrade pip
          pip install -r requirements.txt

      - name: Verify imports
        run: |
          export PYTHONPATH=$PYTHONPATH:$(pwd)/packages
          cd backend
          python -c "from server import app; print('âœ“ Server imports OK')"
        env:
          MONGO_URL: mongodb://localhost:27017/test
          DB_NAME: test
          JWT_SECRET: dummy
          EMERGENT_LLM_KEY: dummy
          MIDTRANS_SERVER_KEY: dummy
          MIDTRANS_CLIENT_KEY: dummy

  # ===========================================
  # Job 2: Frontend Build Check
  # ===========================================
  test-frontend:
    name: Frontend Verification
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          # --- PERBAIKAN: HAPUS CACHE ---
          # Kita hapus cache: 'npm' karena package-lock.json tidak ada
          # Ini akan mencegah error "file not found"

      - name: Install dependencies
        run: |
          # Masuk ke folder frontend
          cd frontend
          npm install --legacy-peer-deps
          npm install ajv@8 --save-dev --legacy-peer-deps

      - name: Build Test
        run: |
          cd frontend
          npm run build
        env:
          REACT_APP_BACKEND_URL: http://relasi4warna.com
          CI: false

  # ===========================================
  # Job 3: Build & Push Docker Images
  # ===========================================
  build-push:
    name: Build & Push Docker
    runs-on: ubuntu-latest
    needs: [test-backend, test-frontend]
    
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Login ke Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      # Build Backend
      - name: Build Backend
        uses: docker/build-push-action@v5
        with:
          context: .
          file: infra/docker/Dockerfile.backend
          push: true
          tags: bimsrama/relasi4warna:backend

      # Build Frontend
      - name: Build Frontend
        uses: docker/build-push-action@v5
        with:
          context: .
          file: infra/docker/Dockerfile.frontend
          push: true
          tags: bimsrama/relasi4warna:frontend
          build-args: |
            REACT_APP_BACKEND_URL=http://relasi4warna.com
