name: Fullstack Build & Push

on:
  push:
    branches: [ "main" ]

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

jobs:
  # ===========================================
  # Job 1: Backend Tests & Verification
  # ===========================================
  test-backend:
    name: Backend Verification
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
          cache-dependency-path: backend/requirements.txt

      - name: Install dependencies
        run: |
          cd backend
          pip install --upgrade pip
          pip install -r requirements.txt
          # Install package lokal sebagai mode editable agar terbaca
          pip install -e ../packages/

      - name: Verify imports (Fix ModuleNotFoundError)
        run: |
          # Kita set PYTHONPATH agar mencakup folder packages di root
          export PYTHONPATH=$PYTHONPATH:$(pwd)/packages
          
          cd backend
          # Test import sederhana untuk memastikan tidak ada error syntax
          python -c "from server import app; print('âœ“ Server imports OK')"
        env:
          # Gunakan dummy credentials agar server.py tidak error saat inisialisasi
          MONGO_URL: mongodb://localhost:27017/test
          DB_NAME: test
          JWT_SECRET: test-secret-key-minimum-32-chars
          EMERGENT_LLM_KEY: test-key
          MIDTRANS_SERVER_KEY: test
          MIDTRANS_CLIENT_KEY: test

  # ===========================================
  # Job 2: Frontend Build Check
  # ===========================================
  test-frontend:
    name: Frontend Verification
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          # --- PERBAIKAN DI SINI ---
          # Menggunakan 'npm' bukan 'yarn'
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json

      - name: Install dependencies
        run: |
          cd frontend
          # Menggunakan npm install dengan legacy-peer-deps (sesuai Dockerfile kita)
          npm install --legacy-peer-deps
          npm install ajv@8 --save-dev --legacy-peer-deps

      - name: Build Test
        run: |
          cd frontend
          npm run build
        env:
          REACT_APP_BACKEND_URL: http://localhost:8001
          CI: false

  # ===========================================
  # Job 3: Build & Push Docker Images
  # ===========================================
  build-push:
    name: Build & Push Docker
    runs-on: ubuntu-latest
    needs: [test-backend, test-frontend] # Hanya jalan jika test sukses
    
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Login ke Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      # Build Backend
      - name: Build Backend
        uses: docker/build-push-action@v5
        with:
          context: .
          file: infra/docker/Dockerfile.backend
          push: true
          tags: bimsrama/relasi4warna:backend

      # Build Frontend
      - name: Build Frontend
        uses: docker/build-push-action@v5
        with:
          context: .
          file: infra/docker/Dockerfile.frontend
          push: true
          tags: bimsrama/relasi4warna:frontend
          build-args: |
            REACT_APP_BACKEND_URL=http://relasi4warna.com
